# z の実装詳細

`z` はシェルスクリプト（`z.sh`）と `awk` を組み合わせて実装されています。
主な仕組みは、ディレクトリの移動履歴をテキストファイルに記録し、独自のアルゴリズム「Frecency」を用いて最適な移動先を計算することです。

## 1. データ保存 (`~/.z`)

デフォルトでは `$HOME/.z` にデータが保存されます。
各行は以下のフォーマットで記録されています。

```text
/path/to/directory|rank|timestamp
```

*   **path**: ディレクトリの絶対パス
*   **rank**: 頻度スコア（アクセス回数などに基づく）
*   **timestamp**: 最後にアクセスした時刻（UNIX時間）

## 2. データの更新プロセス (`--add`)

ユーザーがディレクトリを移動するたびに、フック関数（Bashの `PROMPT_COMMAND` や Zshの `precmd`）が `_z --add` を呼び出します。

1.  **ランクの加算**:
    *   既存のエントリであれば、ランクを加算し、タイムスタンプを現在時刻に更新します。
    *   新規エントリであれば、ランク 1 で追加します。

2.  **エージング（Aging）処理**:
    *   全エントリのランクの合計が `$_Z_MAX_SCORE`（デフォルト 9000）を超えると、すべてのランクに **0.99** を掛けます。
    *   これにより、古いエントリやあまり使われなくなったエントリのスコアが徐々に下がります。
    *   ランクが 1 未満になったエントリは削除されます。

## 3. 検索アルゴリズム (`Frecency`)

`z` コマンド実行時、引数を正規表現として扱い、マッチするディレクトリを検索します。
マッチした候補の中から、**Frecency** スコアが最も高いものが選ばれます。

### Frecency の計算式

`awk` スクリプト内で以下のように計算されます。

```awk
dx = t - time
frecency = int(10000 * rank * (3.75/((0.0001 * dx + 1) + 0.25)))
```

*   `rank`: 保存されているランク
*   `dx`: 現在時刻と最終アクセス時刻の差（秒）
*   この式により、**「最近アクセスしたディレクトリ」** はランクが低くてもスコアが高くなりやすく、**「昔よく使っていたが最近使っていないディレクトリ」** はスコアが下がります。

## 4. 特殊な挙動

*   **共通プレフィックス (Common Root)**:
    *   複数の候補がマッチし、それらすべてに共通する親ディレクトリが存在する場合、個別の候補ではなくその「共通の親ディレクトリ」に移動することがあります（最短一致）。
    *   これは意図しない深い階層へのジャンプを防ぐための仕様ですが、`-r` や `-t` オプション使用時は無効化されます。

*   **タブ補完**:
    *   `bash` の `complete` や `zsh` の `compctl` を使用して、`_z --complete` を呼び出し、マッチする候補を補完リストとして返します。

## 5. オプションの実装

*   **`-r` (Rank)**: Frecency 計算を行わず、単純に `rank` 列の値でソートします。
*   **`-t` (Time)**: 単純に `timestamp` (最近アクセスした順) でソートします。
*   **`-x`**: `sed` コマンドを使用して、カレントディレクトリに一致する行をデータファイルから削除します。
*   **`-c`**: 検索対象を `$PWD` (カレントディレクトリ) 以下のパスに限定します。
