# ディレクトリ移動支援ツール `z` 再実装用 要求仕様書

本ドキュメントは、既存の `z` ツールの機能を別言語または新しい設計で再実装するための要求仕様をまとめたものである。

## 1. 概要
ユーザーのディレクトリ移動履歴を学習し、頻度 (Frequency) と 直近のアクセス (Recency) に基づく「Frecency」アルゴリズムを用いて、少ないキーストロークで目的のディレクトリへ移動できるコマンドラインツールを提供する。
実装は `alt-z` という単一のコマンドと、そのサブコマンド (`add`, `query`, `clean`) によって構成される。

## 2. 機能要件 (Functional Requirements)

### 2.1. 履歴の追跡と記録 (Tracking)
*   **FR1-1**: ユーザーがシェル上でディレクトリを変更 (`cd`) した際、自動的にそのイベントを検知し、データベースを更新しなければならない。
*   **FR1-2**: データベースには各エントリごとに以下の情報を保持すること。
    *   ディレクトリの絶対パス
    *   ランク (Rank): アクセス頻度を示す数値
    *   タイムスタンプ (Timestamp): 最後にアクセスした時刻 (UNIX時間)
*   **FR1-3**: 既存のエントリに再アクセスした場合、ランクを加算し、タイムスタンプを現在時刻に更新すること。
*   **FR1-4**: **エージング処理**: 全エントリのランク合計が設定された閾値（デフォルト: 9000）を超えた場合、全エントリのランクに減衰係数（デフォルト: 0.99）を掛け、ランクが 1 未満になったエントリを削除すること。
*   **FR1-5**: 特定のディレクトリ（例: ホームディレクトリ、除外設定されたパス）は記録対象外とすること。

### 2.2. 検索と移動 (Query & Navigation)
*   **FR2-1**: コマンドライン引数として与えられた文字列（複数可）を正規表現パターンとして扱い、履歴データの中からマッチするパスを検索すること。
*   **FR2-2**: 複数の引数が与えられた場合、それらすべてにマッチするパスを検索対象とすること（AND検索）。
*   **FR2-3**: マッチした候補の中から、指定されたアルゴリズム（デフォルトは Frecency）に基づいて最もスコアが高いディレクトリを選択すること。
*   **FR2-4**: 選択されたディレクトリへカレントディレクトリを変更すること。

### 2.3. スコアリングアルゴリズム (Scoring)
*   **FR3-1 (Frecency)**: デフォルトのスコアリング。ランクと、最終アクセスからの経過時間を組み合わせた計算式を用いること。
    *   要件: 最近アクセスしたディレクトリはランクが低くても上位に来るように重み付けを行う。
*   **FR3-2 (Rank)**: オプション指定時、単純にランクの高さでソートすること。
*   **FR3-3 (Recency)**: オプション指定時、単純にタイムスタンプの新しい順でソートすること。

### 2.4. コマンドラインオプション
以下のオプションをサポートすること。
*   `-c`: 検索対象をカレントディレクトリのサブディレクトリに限定する。
*   `-e`: 移動は行わず、ベストマッチしたパスを標準出力に表示する（echo）。
*   `-h`: ヘルプメッセージを表示する。
*   `-l`: 移動は行わず、マッチした候補をスコア順にリスト表示する。
*   `-r`: Frecency の代わりにランク (Rank) 順で検索する。
*   `-t`: Frecency の代わりに時間 (Time/Recency) 順で検索する。
*   `-x`: カレントディレクトリを履歴データベースから削除する。

### 2.5. シェル統合
*   **FR5-1**: Bash および Zsh シェルでの動作をサポートすること。
*   **FR5-2**: シェルのフック機能（`PROMPT_COMMAND`, `precmd` 等）を利用して、ユーザーの操作を阻害せずにバックグラウンドで履歴更新を行うこと。
*   **FR5-3**: タブ補完機能を提供し、引数入力時に履歴にあるディレクトリ名を補完できるようにすること。

## 3. 非機能要件 (Non-Functional Requirements)

### 3.1. パフォーマンス
*   **NFR1-1**: シェルのプロンプト表示ごとの履歴更新処理は、ユーザーが体感できる遅延を発生させないこと（数ミリ秒〜数十ミリ秒オーダー）。
*   **NFR1-2**: 数千件程度の履歴データがあっても、検索と移動は瞬時に完了すること。

### 3.2. データ整合性
*   **NFR2-1**: 複数のターミナル（シェルプロセス）が同時に履歴ファイルを更新しようとした場合でも、データが破損しないように排他制御やアトミックな書き込みを行うこと。

### 3.3. 移植性
*   **NFR3-1**: 特殊な依存関係を必要とせず、標準的な UNIX 環境で動作することが望ましい。

## 4. データ形式と互換性 (Data Format & Compatibility)
既存の `z` 実装との完全な互換性を維持するため、データファイルは以下の形式に厳密に従うこと。

*   **FR4-1**: データファイルはパイプ (`|`) 区切りのプレーンテキスト形式とする。
    ```text
    /absolute/path/to/dir|rank|timestamp
    ```
*   **FR4-2**: 各フィールドの定義:
    *   **path**: ディレクトリの絶対パス。
    *   **rank**: 頻度スコア。浮動小数点数または整数。
    *   **timestamp**: 最終アクセス時刻。UNIXエポック秒（整数）。
*   **FR4-3**: 既存の `~/.z` ファイルをそのまま読み込み、更新できること。また、本ツールで更新したファイルがオリジナルの `z` でも問題なく読み込めること。
